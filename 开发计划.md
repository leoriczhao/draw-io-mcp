# Role
ä½ æ˜¯ä¸€ä¸ªå‰ç«¯ä½“éªŒä¸“å®¶å’Œç³»ç»Ÿæ¶æ„å¸ˆã€‚æˆ‘ä»¬å°†ä¼˜åŒ– "Draw.io + MCP" ç³»ç»Ÿã€‚
é‡ç‚¹æ”¹è¿›ï¼šåœ¨ Draw.io ç•Œé¢ä¸­æ·»åŠ å¯è§†åŒ–çš„çŠ¶æ€æ ï¼Œå±•ç¤ºè¿æ¥çŠ¶æ€å’Œå½“å‰ Session ä¿¡æ¯ã€‚

# Architecture
1.  **Server (Docker)**: æ‰˜ç®¡ Draw.io å’Œæ’ä»¶ã€‚
2.  **Client (Local MCP)**: ç»´æŠ¤å¤š Tab çŠ¶æ€ã€‚

---

# Project A: Server-Side (`drawio-server-ui`)

## `plugins/mcp-ui.js`
è¯·ç¼–å†™ä¸€ä¸ªå¸¦æœ‰ UI åé¦ˆçš„åŸç”Ÿæ’ä»¶ã€‚

**Feature 1: Visual Status Bar**
- ä½¿ç”¨ `ui.menubar.container` æˆ– `ui.toolbar.container`ã€‚
- åœ¨ç•Œé¢å³ä¸Šè§’æ³¨å…¥ä¸€ä¸ª `div` æˆ– `span`ã€‚
- **é»˜è®¤çŠ¶æ€**: æ˜¾ç¤º ğŸ”´ (çº¢è‰²åœ†ç‚¹) + "Disconnected"ã€‚
- **è¿æ¥æˆåŠŸ**: æ˜¾ç¤º ğŸŸ¢ (ç»¿è‰²åœ†ç‚¹) + "Connected to Claude"ã€‚
- **Session Info**: åœ¨çŠ¶æ€æ—æ˜¾ç¤ºå½“å‰ç”Ÿæˆçš„ SessionID (æˆªå–å‰4ä½) å’Œ **å½“å‰å›¾è¡¨æ–‡ä»¶å** (ä½¿ç”¨ `ui.editor.getOrCreateFilename()`)ã€‚

**Feature 2: Smart Sync**
- ç”Ÿæˆ `TAB_ID` (UUID)ã€‚
- ç›‘å¬ `autosave`, `save`, `focus` äº‹ä»¶ã€‚
- è§¦å‘åŒæ­¥æ—¶ï¼Œå‘é€ POST è¯·æ±‚åˆ° `http://localhost:3000/update`ã€‚
- Payload: `{ id: TAB_ID, filename: string, xml: string }`ã€‚
- **UI Feedback**:
    - `fetch` æˆåŠŸ -> æ›´æ–°çŠ¶æ€æ ä¸º ğŸŸ¢ã€‚
    - `fetch` å¤±è´¥ -> æ›´æ–°çŠ¶æ€æ ä¸º ğŸ”´ã€‚

---

# Project B: Local MCP Server (`local-mcp-ui`)

## `index.js`
æ›´æ–° Server é€»è¾‘ä»¥æ”¯æŒå…ƒæ•°æ® (Metadata)ã€‚

1.  **Session Structure**:
    ```javascript
    sessions.set(id, {
        filename: "æ¶æ„å›¾v1.drawio",
        xml: "<xml...>",
        lastActive: Date.now()
    });
    ```
2.  **Focus Handler**:
    - æ¥æ”¶ POST `/focus`ã€‚
    - æ›´æ–° `activeSessionId`ã€‚
    - æ‰“å°æ—¥å¿—: `[Focus] User is looking at: ${filename} (ID: ${id})`ã€‚
3.  **MCP Tool: `get_active_diagram`**:
    - è·å– `activeSessionId` å¯¹åº”çš„ Sessionã€‚
    - è¿”å›æ–‡æœ¬:
      `Current Diagram: ${session.filename} (ID: ${session.id})\n\nContent:\n${session.xml}`
    - è¿™æ · Claude ä¹Ÿèƒ½çŸ¥é“å®ƒæ­£åœ¨çœ‹ä»€ä¹ˆæ–‡ä»¶ã€‚

---

# Execution
è¯·ç”Ÿæˆä»£ç ã€‚
é‡ç‚¹ç¡®ä¿æ’ä»¶çš„ UI ä»£ç ä¸ä¼šç ´å Draw.io åŸæœ‰çš„å¸ƒå±€ (ä½¿ç”¨ absolute positioning æˆ– flex æ’å…¥åˆ°èœå•æ å³ä¾§)ã€‚
